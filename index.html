<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PT. Jaya Kencana Form System</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100%;
        }

        html {
            height: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #00d4ff, #9c27b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .login-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-type-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .login-type-btn.active {
            background: linear-gradient(45deg, #00d4ff, #9c27b0);
            border-color: transparent;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4);
        }

        .main-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .company-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #9c27b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-subtitle {
            font-size: 18px;
            color: #b0b0b0;
            font-weight: 400;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .navigation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .nav-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .nav-card.active {
            background: linear-gradient(45deg, #00d4ff, #9c27b0);
            border-color: transparent;
        }

        .nav-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #00d4ff;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dropdown-container {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 30, 60, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
        }

        .item-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-number {
            font-weight: 600;
            color: #00d4ff;
            font-size: 16px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-clear {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .btn-delete {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .btn-add {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .photo-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px;
        }

        .history-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .btn-download {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-edit {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 50px;
        }

        .copyright {
            color: #b0b0b0;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .navigation-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .company-title {
                font-size: 28px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="loginScreen" class="login-container">
   <div class="login-card">
    <h1 class="login-title" id="companyTitle">PT. JAYA KENCANA</h1>
    <form id="loginForm">
     <div class="form-group"><label for="username" class="form-label">Username</label> <input type="text" id="username" class="form-input" placeholder="Masukkan username" required>
     </div>
     <div class="form-group"><label for="password" class="form-label">Password</label> <input type="password" id="password" class="form-input" placeholder="Masukkan password" required>
     </div><button type="submit" class="btn-primary">Login</button>
    </form>
   </div>
  </div>
  <div id="mainScreen" class="container hidden"><button class="logout-btn" onclick="logout()">Logout</button>
   <header class="main-header">
    <h1 class="company-title" id="mainCompanyTitle">PT. JAYA KENCANA</h1>
    <p class="user-subtitle" id="userSubtitle">Selamat datang</p>
   </header>
   <nav class="navigation-grid">
    <div class="nav-card" data-section="escalator"><span class="nav-icon">🔧</span>
     <div class="nav-title">
      Safety Eskalator
     </div>
    </div>
    <div class="nav-card" data-section="elevator"><span class="nav-icon">🏗️</span>
     <div class="nav-title">
      Safety Elevator
     </div>
    </div>
    <div class="nav-card" data-section="realization"><span class="nav-icon">📊</span>
     <div class="nav-title">
      Realisasi
     </div>
    </div>
    <div class="nav-card" data-section="history"><span class="nav-icon">📋</span>
     <div class="nav-title">
      History
     </div>
    </div>
   </nav>
   <main id="contentArea"><!-- Content will be dynamically loaded here -->
   </main>
   <footer class="footer">
    <p class="copyright" id="copyrightText">Copyright 2025 PT. Jaya Kencana</p>
   </footer>
  </div>
  <script>
        // Configuration object for Element SDK
        const defaultConfig = {
            company_name: "PT. JAYA KENCANA",
            copyright_text: "Copyright 2025 PT. Jaya Kencana"
        };

        // Global variables
        let currentUser = null;
        let currentUserType = 'user';
        let currentSection = null;
        let formData = [];
        let itemCounter = 0;
        let workCounter = 0;

        // User data configuration
        const userData = {
            'user1': {
                technicians: ['Teknisi A', 'Teknisi B', 'Teknisi C'],
                buildings: ['Gedung Plaza 1', 'Gedung Plaza 2', 'Mall Central']
            },
            'user2': {
                technicians: ['Teknisi D', 'Teknisi E'],
                buildings: ['Tower Office', 'Apartment Sky']
            },
            'admin1': {
                technicians: ['Admin Tech 1', 'Admin Tech 2'],
                buildings: ['All Buildings']
            }
        };

        // Dropdown options
        const dropdownOptions = {
            buildings: ['Gedung Plaza 1', 'Gedung Plaza 2', 'Mall Central', 'Tower Office', 'Apartment Sky'],
            spareparts: ['Motor', 'Brake', 'Cable', 'Control Panel', 'Sensor', 'Button'],
            conditions: ['Baik', 'Rusak Ringan', 'Rusak Berat', 'Perlu Penggantian'],
            quantities: ['1', '2', '3', '4', '5', '10', '20'],
            units: ['Pcs', 'Set', 'Meter', 'Roll', 'Box'],
            remarks: ['Urgent', 'Normal', 'Low Priority', 'Scheduled'],
            priorities: ['High', 'Medium', 'Low'],
            additionalWork: ['Pembersihan', 'Pelumasan', 'Kalibrasi', 'Inspeksi', 'Perbaikan'],
            workConditions: ['Selesai', 'Dalam Proses', 'Tertunda', 'Perlu Review'],
            workRemarks: ['Sesuai Jadwal', 'Terlambat', 'Dipercepat', 'Perlu Koordinasi']
        };

        // Sparepart to unit mapping
        const sparepartUnitMapping = {
            'Cable': 'Meter',
            'Motor': 'Unit',
            'Control Panel': 'Unit',
            'Brake': 'Unit',
            'Sensor': 'Pcs',
            'Button': 'Pcs'
        };

        // Data handler for SDK
        const dataHandler = {
            onDataChanged(data) {
                formData = data;
                if (currentSection === 'history') {
                    renderHistory();
                }
            }
        };

        // Initialize Element SDK
        async function initializeElementSDK() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        const companyTitle = document.getElementById('companyTitle');
                        const mainCompanyTitle = document.getElementById('mainCompanyTitle');
                        const copyrightText = document.getElementById('copyrightText');
                        
                        if (companyTitle) companyTitle.textContent = config.company_name || defaultConfig.company_name;
                        if (mainCompanyTitle) mainCompanyTitle.textContent = config.company_name || defaultConfig.company_name;
                        if (copyrightText) copyrightText.textContent = config.copyright_text || defaultConfig.copyright_text;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["company_name", config.company_name || defaultConfig.company_name],
                        ["copyright_text", config.copyright_text || defaultConfig.copyright_text]
                    ])
                });
            }
        }

        // Initialize Data SDK
        async function initializeDataSDK() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }
        }

        // Initialize application
        async function initializeApp() {
            await initializeElementSDK();
            await initializeDataSDK();
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Navigation
            document.querySelectorAll('.nav-card').forEach(card => {
                card.addEventListener('click', function() {
                    const section = this.dataset.section;
                    navigateToSection(section);
                });
            });
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Validate credentials
            if ((username === 'user1' && password === '123') || 
                (username === 'admin' && password === 'admin123')) {
                
                currentUser = username;
                currentUserType = username === 'admin' ? 'admin' : 'user';
                
                // Update user subtitle
                const userSubtitle = document.getElementById('userSubtitle');
                userSubtitle.textContent = `Selamat datang, ${username.toUpperCase()}`;
                
                // Show main screen
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                
                // Show navigation initially
                document.querySelector('.navigation-grid').style.display = 'grid';
            } else {
                showMessage("Username atau password salah!", "error");
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            currentUserType = 'user';
            currentSection = null;
            
            // Reset form
            document.getElementById('loginForm').reset();
            
            // Reset navigation
            document.querySelector('.navigation-grid').style.display = 'grid';
            document.getElementById('contentArea').innerHTML = '';
            document.querySelectorAll('.nav-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show login screen
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Navigate to section
        function navigateToSection(section) {
            currentSection = section;
            
            // Hide navigation and show content
            document.querySelector('.navigation-grid').style.display = 'none';
            
            // Update navigation active state
            document.querySelectorAll('.nav-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Reset counters when navigating
            itemCounter = 0;
            workCounter = 0;
            
            // Render content
            const contentArea = document.getElementById('contentArea');
            
            switch(section) {
                case 'escalator':
                case 'elevator':
                    renderFormSection(section);
                    break;
                case 'realization':
                    renderRealizationSection();
                    break;
                case 'history':
                    renderHistorySection();
                    break;
            }
        }

        // Render form section
        function renderFormSection(type) {
            const title = type === 'escalator' ? 'Safety Eskalator' : 'Safety Elevator';
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin: 0;">${title}</h2>
                        <button type="button" class="btn-small" onclick="backToNavigation()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">← Kembali</button>
                    </div>
                    
                    <form id="mainForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="buildingName" class="form-label">Nama Gedung/Proyek</label>
                                <div class="dropdown-container">
                                    <input type="text" id="buildingName" class="form-input" placeholder="Pilih atau ketik nama gedung" autocomplete="off" required>
                                    <div id="buildingDropdown" class="dropdown-list"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nama Teknisi</label>
                                <div class="checkbox-group" id="technicianCheckboxes">
                                    <!-- Technician checkboxes will be populated here -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="workDate" class="form-label">Tanggal</label>
                                <input type="date" id="workDate" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="headerUnit" class="form-label">Unit</label>
                                <input type="text" id="headerUnit" class="form-input" placeholder="Masukkan unit" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="headerMFG" class="form-label">MFG</label>
                                <input type="text" id="headerMFG" class="form-input" placeholder="Masukkan MFG" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="headerType" class="form-label">Type</label>
                                <input type="text" id="headerType" class="form-input" placeholder="Masukkan type" required>
                            </div>
                        </div>
                        
                        <div class="section-title" style="margin-top: 30px;">ITEM</div>
                        <div id="itemsContainer">
                            <!-- Items will be added here -->
                        </div>
                        
                        <div id="additionalWorkContainer">
                            <!-- Additional work will be added here -->
                        </div>
                        
                        <div style="margin: 30px 0 20px 0;">
                            <button type="button" class="btn-add" onclick="addItem()">+ Tambah Item</button>
                            <button type="button" class="btn-add" onclick="addWork()">+ Tambah Pekerjaan</button>
                        </div>
                        
                        <button type="submit" class="btn-primary">Submit</button>
                    </form>
                </div>
            `;
            
            // Populate technician checkboxes
            populateTechnicianCheckboxes();
            
            // Setup dropdown for building name
            setupDropdown('buildingName', 'buildingDropdown', getUserBuildings());
            
            // Setup form submission
            document.getElementById('mainForm').addEventListener('submit', handleFormSubmit);
            
            // Set current date
            document.getElementById('workDate').valueAsDate = new Date();
            
            // Add initial item
            addItem();
        }

        // Populate technician checkboxes
        function populateTechnicianCheckboxes() {
            const container = document.getElementById('technicianCheckboxes');
            const technicians = getUserTechnicians();
            
            container.innerHTML = technicians.map(tech => `
                <div class="checkbox-item">
                    <input type="checkbox" id="tech_${tech}" name="technicians" value="${tech}">
                    <label for="tech_${tech}">${tech}</label>
                </div>
            `).join('');
        }

        // Get user technicians
        function getUserTechnicians() {
            return userData[currentUser] ? userData[currentUser].technicians : ['Teknisi Default'];
        }

        // Get user buildings
        function getUserBuildings() {
            return userData[currentUser] ? userData[currentUser].buildings : dropdownOptions.buildings;
        }

        // Setup dropdown functionality
        function setupDropdown(inputId, dropdownId, options) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filtered = options.filter(option => 
                    option.toLowerCase().includes(value)
                );
                
                if (filtered.length > 0 && value) {
                    dropdown.innerHTML = filtered.map(option => 
                        `<div class="dropdown-item" onclick="selectDropdownItem('${inputId}', '${option}')">${option}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });
            
            input.addEventListener('focus', function() {
                if (options.length > 0) {
                    dropdown.innerHTML = options.map(option => 
                        `<div class="dropdown-item" onclick="selectDropdownItem('${inputId}', '${option}')">${option}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Select dropdown item
        function selectDropdownItem(inputId, value) {
            document.getElementById(inputId).value = value;
            document.getElementById(inputId.replace(/([A-Z])/g, '$1') + 'Dropdown').style.display = 'none';
        }

        // Add item
        function addItem() {
            itemCounter++;
            const container = document.getElementById('itemsContainer');
            
            const itemHtml = `
                <div class="item-container" id="item_${itemCounter}">
                    <div class="item-header">
                        <span class="item-number">Item ${itemCounter}</span>
                        <div class="item-actions">
                            <button type="button" class="btn-small btn-clear" onclick="clearItem(${itemCounter})">Clear</button>
                            <button type="button" class="btn-small btn-delete" onclick="deleteItem(${itemCounter})">Delete</button>
                        </div>
                    </div>
                    

                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Item Sparepart</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="sparepart_${itemCounter}" placeholder="Pilih sparepart" autocomplete="off">
                                <div class="dropdown-list" id="sparepart_dropdown_${itemCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kondisi</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="condition_${itemCounter}" placeholder="Pilih kondisi" autocomplete="off">
                                <div class="dropdown-list" id="condition_dropdown_${itemCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Jumlah</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="quantity_${itemCounter}" placeholder="Pilih jumlah" autocomplete="off">
                                <div class="dropdown-list" id="quantity_dropdown_${itemCounter}"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Satuan</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="unit_type_${itemCounter}" placeholder="Pilih satuan" autocomplete="off">
                                <div class="dropdown-list" id="unit_dropdown_${itemCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Remarks</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="remarks_${itemCounter}" placeholder="Pilih remarks" autocomplete="off">
                                <div class="dropdown-list" id="remarks_dropdown_${itemCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prioritas</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="priority_${itemCounter}" placeholder="Pilih prioritas" autocomplete="off">
                                <div class="dropdown-list" id="priority_dropdown_${itemCounter}"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Foto Part</label>
                        <div id="photoContainer_${itemCounter}">
                            <div class="photo-upload" onclick="addPhotoUpload(${itemCounter}, 1)">
                                <span>📷 Klik untuk upload foto</span>
                                <input type="file" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this, ${itemCounter}, 1)">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
            
            // Setup dropdowns for this item
            setupItemDropdowns(itemCounter);
        }

        // Setup dropdowns for item
        function setupItemDropdowns(itemId) {
            const dropdowns = [
                { input: `sparepart_${itemId}`, dropdown: `sparepart_dropdown_${itemId}`, options: dropdownOptions.spareparts },
                { input: `condition_${itemId}`, dropdown: `condition_dropdown_${itemId}`, options: dropdownOptions.conditions },
                { input: `quantity_${itemId}`, dropdown: `quantity_dropdown_${itemId}`, options: dropdownOptions.quantities },
                { input: `unit_dropdown_${itemId}`, dropdown: `unit_dropdown_${itemId}`, options: dropdownOptions.units },
                { input: `remarks_${itemId}`, dropdown: `remarks_dropdown_${itemId}`, options: dropdownOptions.remarks },
                { input: `priority_${itemId}`, dropdown: `priority_dropdown_${itemId}`, options: dropdownOptions.priorities }
            ];
            
            dropdowns.forEach(({ input, dropdown, options }) => {
                const inputElement = document.querySelector(`[name="${input}"]`);
                const dropdownElement = document.getElementById(dropdown);
                
                if (inputElement && dropdownElement) {
                    setupDropdownForElement(inputElement, dropdownElement, options);
                }
            });
        }

        // Setup dropdown for specific element
        function setupDropdownForElement(input, dropdown, options) {
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filtered = options.filter(option => 
                    option.toLowerCase().includes(value)
                );
                
                if (filtered.length > 0 && value) {
                    dropdown.innerHTML = filtered.map(option => 
                        `<div class="dropdown-item" onclick="selectDropdownValue(this, '${option}')">${option}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });
            
            input.addEventListener('focus', function() {
                dropdown.innerHTML = options.map(option => 
                    `<div class="dropdown-item" onclick="selectDropdownValue(this, '${option}')">${option}</div>`
                ).join('');
                dropdown.style.display = 'block';
            });
        }

        // Select dropdown value
        function selectDropdownValue(element, value) {
            const dropdown = element.parentElement;
            const input = dropdown.previousElementSibling;
            input.value = value;
            dropdown.style.display = 'none';
            
            // Auto-update unit if sparepart is selected
            if (input.name && input.name.includes('sparepart_')) {
                const itemId = input.name.split('_')[1];
                const unitInput = document.querySelector(`[name="unit_type_${itemId}"]`);
                if (unitInput && sparepartUnitMapping[value]) {
                    unitInput.value = sparepartUnitMapping[value];
                }
            }
        }

        // Clear item
        function clearItem(itemId) {
            const item = document.getElementById(`item_${itemId}`);
            const inputs = item.querySelectorAll('input[type="text"], input[type="file"]');
            inputs.forEach(input => {
                input.value = '';
            });
            
            // Clear photo previews (including containers)
            const photoContainer = document.getElementById(`photoContainer_${itemId}`);
            const previewContainers = photoContainer.querySelectorAll('div[style*="position: relative"]');
            previewContainers.forEach(container => container.remove());
        }

        // Delete item
        function deleteItem(itemId) {
            const item = document.getElementById(`item_${itemId}`);
            if (item) {
                item.remove();
                renumberItems();
            }
        }

        // Renumber items after deletion
        function renumberItems() {
            const itemContainers = document.querySelectorAll('#itemsContainer .item-container[id^="item_"]');
            itemContainers.forEach((container, index) => {
                const newItemId = index + 1;
                const itemNumber = container.querySelector('.item-number');
                if (itemNumber) {
                    itemNumber.textContent = `Item ${newItemId}`;
                }
                
                // Update the container ID
                container.id = `item_${newItemId}`;
                
                // Update all input names and related IDs within this container
                const inputs = container.querySelectorAll('input[name*="_"]');
                inputs.forEach(input => {
                    if (input.name) {
                        const nameParts = input.name.split('_');
                        if (nameParts.length > 1) {
                            nameParts[nameParts.length - 1] = newItemId.toString();
                            input.name = nameParts.join('_');
                        }
                    }
                });
                
                // Update dropdown IDs
                const dropdowns = container.querySelectorAll('[id*="_dropdown_"], [id*="photoContainer_"]');
                dropdowns.forEach(dropdown => {
                    if (dropdown.id) {
                        const idParts = dropdown.id.split('_');
                        if (idParts.length > 1) {
                            idParts[idParts.length - 1] = newItemId.toString();
                            dropdown.id = idParts.join('_');
                        }
                    }
                });
                
                // Update button onclick attributes
                const clearBtn = container.querySelector('.btn-clear');
                const deleteBtn = container.querySelector('.btn-delete');
                
                if (clearBtn) {
                    clearBtn.setAttribute('onclick', `clearItem(${newItemId})`);
                }
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `deleteItem(${newItemId})`);
                }
                
                // Update photo upload buttons
                const photoUploadBtn = container.querySelector('.photo-upload');
                const photoInput = container.querySelector('input[type="file"]');
                
                if (photoUploadBtn) {
                    photoUploadBtn.setAttribute('onclick', `addPhotoUpload(${newItemId}, 1)`);
                }
                if (photoInput) {
                    photoInput.setAttribute('onchange', `handlePhotoUpload(this, ${newItemId}, 1)`);
                }
            });
            
            // Update the global counter
            itemCounter = itemContainers.length;
        }

        // Add work
        function addWork() {
            workCounter++;
            const container = document.getElementById('additionalWorkContainer');
            
            const workHtml = `
                <div class="item-container" id="work_${workCounter}">
                    <div class="item-header">
                        <span class="item-number">Pekerjaan ${workCounter}</span>
                        <div class="item-actions">
                            <button type="button" class="btn-small btn-clear" onclick="clearWork(${workCounter})">Clear</button>
                            <button type="button" class="btn-small btn-delete" onclick="deleteWork(${workCounter})">Delete</button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pekerjaan Lainnya</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="additional_work_${workCounter}" placeholder="Pilih pekerjaan" autocomplete="off">
                                <div class="dropdown-list" id="work_dropdown_${workCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kondisi</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="work_condition_${workCounter}" placeholder="Pilih kondisi" autocomplete="off">
                                <div class="dropdown-list" id="work_condition_dropdown_${workCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Keterangan</label>
                            <input type="text" class="form-input" name="work_description_${workCounter}" placeholder="Masukkan keterangan">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Remarks</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="work_remarks_${workCounter}" placeholder="Pilih remarks" autocomplete="off">
                                <div class="dropdown-list" id="work_remarks_dropdown_${workCounter}"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prioritas</label>
                            <div class="dropdown-container">
                                <input type="text" class="form-input" name="work_priority_${workCounter}" placeholder="Pilih prioritas" autocomplete="off">
                                <div class="dropdown-list" id="work_priority_dropdown_${workCounter}"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Foto</label>
                        <div id="workPhotoContainer_${workCounter}">
                            <div class="photo-upload" onclick="addWorkPhotoUpload(${workCounter}, 1)">
                                <span>📷 Klik untuk upload foto</span>
                                <input type="file" accept="image/*" style="display: none;" onchange="handleWorkPhotoUpload(this, ${workCounter}, 1)">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', workHtml);
            
            // Setup dropdowns for this work
            setupWorkDropdowns(workCounter);
        }

        // Setup dropdowns for work
        function setupWorkDropdowns(workId) {
            const dropdowns = [
                { input: `additional_work_${workId}`, dropdown: `work_dropdown_${workId}`, options: dropdownOptions.additionalWork },
                { input: `work_condition_${workId}`, dropdown: `work_condition_dropdown_${workId}`, options: dropdownOptions.workConditions },
                { input: `work_remarks_${workId}`, dropdown: `work_remarks_dropdown_${workId}`, options: dropdownOptions.workRemarks },
                { input: `work_priority_${workId}`, dropdown: `work_priority_dropdown_${workId}`, options: dropdownOptions.priorities }
            ];
            
            dropdowns.forEach(({ input, dropdown, options }) => {
                const inputElement = document.querySelector(`[name="${input}"]`);
                const dropdownElement = document.getElementById(dropdown);
                
                if (inputElement && dropdownElement) {
                    setupDropdownForElement(inputElement, dropdownElement, options);
                }
            });
        }

        // Clear work
        function clearWork(workId) {
            const work = document.getElementById(`work_${workId}`);
            const inputs = work.querySelectorAll('input[type="text"], input[type="file"]');
            inputs.forEach(input => {
                input.value = '';
            });
            
            // Clear photo previews (including containers)
            const photoContainer = document.getElementById(`workPhotoContainer_${workId}`);
            const previewContainers = photoContainer.querySelectorAll('div[style*="position: relative"]');
            previewContainers.forEach(container => container.remove());
        }

        // Delete work
        function deleteWork(workId) {
            const work = document.getElementById(`work_${workId}`);
            if (work) {
                work.remove();
                renumberWorks();
            }
        }

        // Renumber works after deletion
        function renumberWorks() {
            const workContainers = document.querySelectorAll('#additionalWorkContainer .item-container[id^="work_"]');
            workContainers.forEach((container, index) => {
                const newWorkId = index + 1;
                const workNumber = container.querySelector('.item-number');
                if (workNumber) {
                    workNumber.textContent = `Pekerjaan ${newWorkId}`;
                }
                
                // Update the container ID
                container.id = `work_${newWorkId}`;
                
                // Update all input names and related IDs within this container
                const inputs = container.querySelectorAll('input[name*="_"]');
                inputs.forEach(input => {
                    if (input.name) {
                        const nameParts = input.name.split('_');
                        if (nameParts.length > 1) {
                            nameParts[nameParts.length - 1] = newWorkId.toString();
                            input.name = nameParts.join('_');
                        }
                    }
                });
                
                // Update dropdown IDs
                const dropdowns = container.querySelectorAll('[id*="_dropdown_"], [id*="workPhotoContainer_"]');
                dropdowns.forEach(dropdown => {
                    if (dropdown.id) {
                        const idParts = dropdown.id.split('_');
                        if (idParts.length > 1) {
                            idParts[idParts.length - 1] = newWorkId.toString();
                            dropdown.id = idParts.join('_');
                        }
                    }
                });
                
                // Update button onclick attributes
                const clearBtn = container.querySelector('.btn-clear');
                const deleteBtn = container.querySelector('.btn-delete');
                
                if (clearBtn) {
                    clearBtn.setAttribute('onclick', `clearWork(${newWorkId})`);
                }
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `deleteWork(${newWorkId})`);
                }
                
                // Update photo upload buttons
                const photoUploadBtn = container.querySelector('.photo-upload');
                const photoInput = container.querySelector('input[type="file"]');
                
                if (photoUploadBtn) {
                    photoUploadBtn.setAttribute('onclick', `addWorkPhotoUpload(${newWorkId}, 1)`);
                }
                if (photoInput) {
                    photoInput.setAttribute('onchange', `handleWorkPhotoUpload(this, ${newWorkId}, 1)`);
                }
            });
            
            // Update the global counter
            workCounter = workContainers.length;
        }

        // Add photo upload
        function addPhotoUpload(itemId, photoId) {
            const input = document.querySelector(`#photoContainer_${itemId} input[type="file"]:last-of-type`);
            input.click();
        }

        // Handle photo upload
        function handlePhotoUpload(input, itemId, photoId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.getElementById(`photoContainer_${itemId}`);
                    
                    // Create preview container
                    const previewContainer = document.createElement('div');
                    previewContainer.style.cssText = 'position: relative; display: inline-block; margin: 10px;';
                    
                    // Create preview
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'photo-preview';
                    preview.alt = `Photo ${photoId}`;
                    
                    // Create delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '×';
                    deleteBtn.type = 'button';
                    deleteBtn.style.cssText = `
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: #f44336;
                        color: white;
                        border: none;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    deleteBtn.onclick = function() {
                        previewContainer.remove();
                    };
                    
                    previewContainer.appendChild(preview);
                    previewContainer.appendChild(deleteBtn);
                    
                    // Insert before the upload button
                    const uploadButton = container.querySelector('.photo-upload');
                    container.insertBefore(previewContainer, uploadButton);
                    
                    // Reset the file input so it can be used again
                    input.value = '';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Add work photo upload
        function addWorkPhotoUpload(workId, photoId) {
            const input = document.querySelector(`#workPhotoContainer_${workId} input[type="file"]:last-of-type`);
            input.click();
        }

        // Handle work photo upload
        function handleWorkPhotoUpload(input, workId, photoId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.getElementById(`workPhotoContainer_${workId}`);
                    
                    // Create preview container
                    const previewContainer = document.createElement('div');
                    previewContainer.style.cssText = 'position: relative; display: inline-block; margin: 10px;';
                    
                    // Create preview
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'photo-preview';
                    preview.alt = `Work Photo ${photoId}`;
                    
                    // Create delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '×';
                    deleteBtn.type = 'button';
                    deleteBtn.style.cssText = `
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: #f44336;
                        color: white;
                        border: none;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    deleteBtn.onclick = function() {
                        previewContainer.remove();
                    };
                    
                    previewContainer.appendChild(preview);
                    previewContainer.appendChild(deleteBtn);
                    
                    // Insert before the upload button
                    const uploadButton = container.querySelector('.photo-upload');
                    container.insertBefore(previewContainer, uploadButton);
                    
                    // Reset the file input so it can be used again
                    input.value = '';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Handle form submit
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (formData.length >= 999) {
                showMessage("Batas maksimum 999 data telah tercapai. Silakan hapus beberapa data terlebih dahulu.", "error");
                return;
            }
            
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Show loading state
            submitButton.classList.add('loading');
            submitButton.textContent = 'Menyimpan...';
            
            try {
                // Collect form data
                const formDataObj = {
                    id: Date.now().toString(),
                    type: currentSection,
                    username: currentUser,
                    form_type: currentSection,
                    building_name: document.getElementById('buildingName').value,
                    technician: getSelectedTechnicians(),
                    date: document.getElementById('workDate').value,
                    items: collectItemsData(),
                    additional_work: collectAdditionalWorkData(),
                    created_at: new Date().toISOString(),
                    status: 'submitted'
                };
                
                // Save to Data SDK
                const result = await window.dataSdk.create(formDataObj);
                
                if (result.isOk) {
                    showMessage("Data berhasil disimpan!", "success");
                    
                    // Reset form
                    form.reset();
                    document.getElementById('itemsContainer').innerHTML = '';
                    document.getElementById('additionalWorkContainer').innerHTML = '';
                    itemCounter = 0;
                    workCounter = 0;
                    
                    // Add initial item
                    addItem();
                } else {
                    showMessage("Gagal menyimpan data. Silakan coba lagi.", "error");
                }
            } catch (error) {
                showMessage("Terjadi kesalahan. Silakan coba lagi.", "error");
            } finally {
                // Reset loading state
                submitButton.classList.remove('loading');
                submitButton.textContent = 'Submit';
            }
        }

        // Get selected technicians
        function getSelectedTechnicians() {
            const checkboxes = document.querySelectorAll('input[name="technicians"]:checked');
            return Array.from(checkboxes).map(cb => cb.value).join(', ');
        }

        // Collect items data
        function collectItemsData() {
            const items = [];
            const itemContainers = document.querySelectorAll('[id^="item_"]');
            
            itemContainers.forEach(container => {
                const itemData = {};
                const inputs = container.querySelectorAll('input[type="text"]');
                
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        itemData[input.name] = input.value.trim();
                    }
                });
                
                if (Object.keys(itemData).length > 0) {
                    items.push(itemData);
                }
            });
            
            return JSON.stringify(items);
        }

        // Collect additional work data
        function collectAdditionalWorkData() {
            const works = [];
            const workContainers = document.querySelectorAll('[id^="work_"]');
            
            workContainers.forEach(container => {
                const workData = {};
                const inputs = container.querySelectorAll('input[type="text"]');
                
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        workData[input.name] = input.value.trim();
                    }
                });
                
                if (Object.keys(workData).length > 0) {
                    works.push(workData);
                }
            });
            
            return JSON.stringify(works);
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: linear-gradient(45deg, #4caf50, #45a049);' : 'background: linear-gradient(45deg, #f44336, #d32f2f);'}
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Render realization section
        function renderRealizationSection() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin: 0;">Realisasi</h2>
                        <button type="button" class="btn-small" onclick="backToNavigation()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">← Kembali</button>
                    </div>
                    <p style="text-align: center; color: #b0b0b0; font-size: 18px; margin: 50px 0;">
                        📊 Fitur realisasi akan segera tersedia
                    </p>
                </div>
            `;
        }

        // Render history section
        function renderHistorySection() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="history-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin: 0;">History Data</h2>
                        <button type="button" class="btn-small" onclick="backToNavigation()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">← Kembali</button>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="Cari data..." onkeyup="filterHistory()">
                    </div>
                    
                    <div id="historyList">
                        <!-- History items will be populated here -->
                    </div>
                </div>
            `;
            
            renderHistory();
        }

        // Render history
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            
            let filteredData = formData.filter(item => {
                return item.building_name?.toLowerCase().includes(searchTerm) ||
                       item.technician?.toLowerCase().includes(searchTerm) ||
                       item.form_type?.toLowerCase().includes(searchTerm) ||
                       item.date?.includes(searchTerm);
            });
            
            if (filteredData.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; color: #b0b0b0; padding: 50px;">
                        📋 Belum ada data yang tersimpan
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = filteredData.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        <div>
                            <h3 style="margin: 0; color: #00d4ff;">${item.form_type?.toUpperCase()} - ${item.building_name}</h3>
                            <p style="margin: 5px 0; color: #b0b0b0;">Teknisi: ${item.technician} | Tanggal: ${item.date}</p>
                        </div>
                        <div class="history-actions">
                            <button class="btn-download" onclick="downloadPDF('${item.id}')">📄 PDF</button>
                            <button class="btn-download" onclick="downloadWord('${item.id}')">📝 Word</button>
                            ${currentUserType === 'admin' ? `
                                <button class="btn-edit" onclick="reviewData('${item.id}')" style="background: linear-gradient(45deg, #9c27b0, #673ab7);">👁️ Review</button>
                                <button class="btn-edit" onclick="editData('${item.id}')">✏️ Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteData('${item.id}')">🗑️ Delete</button>
                            ` : ''}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #e0e0e0;">
                        Status: ${item.status} | Dibuat: ${new Date(item.created_at).toLocaleString('id-ID')}
                    </div>
                </div>
            `).join('');
        }

        // Filter history
        function filterHistory() {
            renderHistory();
        }

        // Download PDF
        function downloadPDF(itemId) {
            const item = formData.find(d => d.id === itemId);
            if (!item) return;
            
            // Create PDF content
            const pdfContent = `
                PT. JAYA KENCANA
                LAPORAN ${item.form_type?.toUpperCase()}
                
                Gedung/Proyek: ${item.building_name}
                Teknisi: ${item.technician}
                Tanggal: ${item.date}
                
                ITEMS:
                ${item.items ? JSON.parse(item.items).map((itm, idx) => `
                Item ${idx + 1}:
                ${Object.entries(itm).map(([key, value]) => `${key}: ${value}`).join('\n')}
                `).join('\n') : 'Tidak ada item'}
                
                PEKERJAAN TAMBAHAN:
                ${item.additional_work ? JSON.parse(item.additional_work).map((work, idx) => `
                Pekerjaan ${idx + 1}:
                ${Object.entries(work).map(([key, value]) => `${key}: ${value}`).join('\n')}
                `).join('\n') : 'Tidak ada pekerjaan tambahan'}
                
                Dibuat: ${new Date(item.created_at).toLocaleString('id-ID')}
            `;
            
            // Create and download file
            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${item.form_type}_${item.building_name}_${item.date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage("File berhasil diunduh!", "success");
        }

        // Download Word
        function downloadWord(itemId) {
            // For demo purposes, this creates a text file
            downloadPDF(itemId);
        }

        // Edit data (admin only)
        function editData(itemId) {
            if (currentUserType !== 'admin') return;
            
            const item = formData.find(d => d.id === itemId);
            if (!item) return;
            
            // Navigate to form section with pre-filled data
            navigateToSection(item.form_type);
            
            // Wait for form to render then populate data
            setTimeout(() => {
                populateFormForEdit(item);
            }, 100);
        }

        // Populate form for editing
        function populateFormForEdit(item) {
            // Fill basic form fields
            document.getElementById('buildingName').value = item.building_name || '';
            document.getElementById('workDate').value = item.date || '';
            document.getElementById('headerUnit').value = item.unit || '';
            document.getElementById('headerMFG').value = item.mfg || '';
            document.getElementById('headerType').value = item.type || '';
            
            // Check technician checkboxes
            if (item.technician) {
                const techNames = item.technician.split(', ');
                techNames.forEach(techName => {
                    const checkbox = document.querySelector(`input[value="${techName}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Clear existing items and works
            document.getElementById('itemsContainer').innerHTML = '';
            document.getElementById('additionalWorkContainer').innerHTML = '';
            itemCounter = 0;
            workCounter = 0;
            
            // Populate items
            if (item.items) {
                try {
                    const items = JSON.parse(item.items);
                    items.forEach(itemData => {
                        addItem();
                        const currentItemId = itemCounter;
                        
                        // Fill item data
                        Object.entries(itemData).forEach(([key, value]) => {
                            const input = document.querySelector(`[name="${key}"]`);
                            if (input) input.value = value;
                        });
                    });
                } catch (e) {
                    console.error('Error parsing items:', e);
                }
            }
            
            // Populate additional work
            if (item.additional_work) {
                try {
                    const works = JSON.parse(item.additional_work);
                    works.forEach(workData => {
                        addWork();
                        const currentWorkId = workCounter;
                        
                        // Fill work data
                        Object.entries(workData).forEach(([key, value]) => {
                            const input = document.querySelector(`[name="${key}"]`);
                            if (input) input.value = value;
                        });
                    });
                } catch (e) {
                    console.error('Error parsing additional work:', e);
                }
            }
            
            // Change submit button to update
            const submitBtn = document.querySelector('#mainForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Data';
                submitBtn.onclick = (e) => handleUpdateSubmit(e, item.id);
            }
            
            showMessage("Data berhasil dimuat untuk diedit", "success");
        }

        // Handle update submit
        async function handleUpdateSubmit(e, originalId) {
            e.preventDefault();
            
            const form = e.target.closest('form');
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Show loading state
            submitButton.classList.add('loading');
            submitButton.textContent = 'Mengupdate...';
            
            try {
                // Find original item
                const originalItem = formData.find(d => d.id === originalId);
                if (!originalItem) {
                    showMessage("Data asli tidak ditemukan", "error");
                    return;
                }
                
                // Collect updated form data
                const updatedData = {
                    ...originalItem,
                    building_name: document.getElementById('buildingName').value,
                    technician: getSelectedTechnicians(),
                    date: document.getElementById('workDate').value,
                    items: collectItemsData(),
                    additional_work: collectAdditionalWorkData(),
                    status: 'updated'
                };
                
                // Update via Data SDK
                const result = await window.dataSdk.update(updatedData);
                
                if (result.isOk) {
                    showMessage("Data berhasil diupdate!", "success");
                    
                    // Navigate back to history
                    navigateToSection('history');
                } else {
                    showMessage("Gagal mengupdate data. Silakan coba lagi.", "error");
                }
            } catch (error) {
                showMessage("Terjadi kesalahan. Silakan coba lagi.", "error");
            } finally {
                // Reset loading state
                submitButton.classList.remove('loading');
                submitButton.textContent = 'Update Data';
            }
        }

        // Delete data (admin only)
        async function deleteData(itemId) {
            if (currentUserType !== 'admin') return;
            
            const item = formData.find(d => d.id === itemId);
            if (!item) return;
            
            // Create inline confirmation
            const historyItem = document.querySelector(`[onclick*="${itemId}"]`).closest('.history-item');
            const deleteBtn = historyItem.querySelector(`[onclick*="deleteData('${itemId}')"]`);
            
            if (deleteBtn.textContent === '🗑️ Delete') {
                // First click - show confirmation
                deleteBtn.textContent = 'Konfirmasi Hapus?';
                deleteBtn.style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';
                
                // Add cancel button
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn-small';
                cancelBtn.textContent = 'Batal';
                cancelBtn.style.background = 'rgba(255,255,255,0.1)';
                cancelBtn.style.color = 'white';
                cancelBtn.style.border = '1px solid rgba(255,255,255,0.3)';
                cancelBtn.onclick = () => {
                    deleteBtn.textContent = '🗑️ Delete';
                    deleteBtn.style.background = '';
                    cancelBtn.remove();
                };
                
                deleteBtn.parentNode.insertBefore(cancelBtn, deleteBtn.nextSibling);
                
                // Reset after 5 seconds
                setTimeout(() => {
                    if (deleteBtn.textContent === 'Konfirmasi Hapus?') {
                        deleteBtn.textContent = '🗑️ Delete';
                        deleteBtn.style.background = '';
                        if (cancelBtn.parentNode) cancelBtn.remove();
                    }
                }, 5000);
                
            } else if (deleteBtn.textContent === 'Konfirmasi Hapus?') {
                // Second click - actually delete
                deleteBtn.textContent = 'Menghapus...';
                deleteBtn.disabled = true;
                
                try {
                    const result = await window.dataSdk.delete(item);
                    if (result.isOk) {
                        showMessage("Data berhasil dihapus!", "success");
                        // Remove the history item from DOM
                        historyItem.remove();
                    } else {
                        showMessage("Gagal menghapus data.", "error");
                        deleteBtn.textContent = '🗑️ Delete';
                        deleteBtn.disabled = false;
                    }
                } catch (error) {
                    showMessage("Terjadi kesalahan saat menghapus data.", "error");
                    deleteBtn.textContent = '🗑️ Delete';
                    deleteBtn.disabled = false;
                }
            }
        }

        // Review data (admin only)
        function reviewData(itemId) {
            if (currentUserType !== 'admin') return;
            
            const item = formData.find(d => d.id === itemId);
            if (!item) return;
            
            const contentArea = document.getElementById('contentArea');
            
            let itemsHtml = '';
            if (item.items) {
                try {
                    const items = JSON.parse(item.items);
                    itemsHtml = items.map((itm, idx) => `
                        <div class="item-container">
                            <h4 style="color: #00d4ff; margin-bottom: 10px;">Item ${idx + 1}</h4>
                            ${Object.entries(itm).map(([key, value]) => `
                                <div style="margin-bottom: 8px;">
                                    <strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${value}
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                } catch (e) {
                    itemsHtml = '<p>Error parsing items data</p>';
                }
            }
            
            let worksHtml = '';
            if (item.additional_work) {
                try {
                    const works = JSON.parse(item.additional_work);
                    worksHtml = works.map((work, idx) => `
                        <div class="item-container">
                            <h4 style="color: #00d4ff; margin-bottom: 10px;">Pekerjaan ${idx + 1}</h4>
                            ${Object.entries(work).map(([key, value]) => `
                                <div style="margin-bottom: 8px;">
                                    <strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${value}
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                } catch (e) {
                    worksHtml = '<p>Error parsing work data</p>';
                }
            }
            
            contentArea.innerHTML = `
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin: 0;">Review Data - ${item.form_type?.toUpperCase()}</h2>
                        <button type="button" class="btn-small" onclick="navigateToSection('history')" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">← Kembali ke History</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nama Gedung/Proyek</label>
                            <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0;">
                                ${item.building_name || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Teknisi</label>
                            <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0;">
                                ${item.technician || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tanggal</label>
                            <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0;">
                                ${item.date || 'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0;">
                                ${item.status || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Dibuat</label>
                            <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0;">
                                ${new Date(item.created_at).toLocaleString('id-ID')}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">User</label>
                            <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0;">
                                ${item.username || 'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    ${itemsHtml ? `
                        <div class="section-title" style="margin-top: 30px;">ITEMS</div>
                        ${itemsHtml}
                    ` : ''}
                    
                    ${worksHtml ? `
                        <div class="section-title" style="margin-top: 30px;">PEKERJAAN TAMBAHAN</div>
                        ${worksHtml}
                    ` : ''}
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn-primary" onclick="editData('${item.id}')" style="margin-right: 10px;">✏️ Edit Data Ini</button>
                        <button class="btn-primary" onclick="approveData('${item.id}')" style="background: linear-gradient(45deg, #4caf50, #45a049);">✅ Approve</button>
                    </div>
                </div>
            `;
        }

        // Approve data (admin only)
        async function approveData(itemId) {
            if (currentUserType !== 'admin') return;
            
            const item = formData.find(d => d.id === itemId);
            if (!item) return;
            
            try {
                const updatedData = {
                    ...item,
                    status: 'approved'
                };
                
                const result = await window.dataSdk.update(updatedData);
                
                if (result.isOk) {
                    showMessage("Data berhasil di-approve!", "success");
                    navigateToSection('history');
                } else {
                    showMessage("Gagal approve data.", "error");
                }
            } catch (error) {
                showMessage("Terjadi kesalahan saat approve data.", "error");
            }
        }

        // Back to navigation
        function backToNavigation() {
            document.querySelector('.navigation-grid').style.display = 'grid';
            document.getElementById('contentArea').innerHTML = '';
            document.querySelectorAll('.nav-card').forEach(card => {
                card.classList.remove('active');
            });
            currentSection = null;
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'997b618873944083',t:'MTc2MTk5OTk5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
